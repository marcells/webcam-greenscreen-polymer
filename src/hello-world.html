<!-- Import Polymer -->
<link rel="import" href="../bower_components/polymer/polymer.html">

<!-- Define your custom element -->
<polymer-element name="hello-world" attributes="width height audio">
    <template>
    	<style>
    		#webcam, #canvasSource { display: none;}
    	</style>

    	<video id="webcam" width="{{width}}" height="{{height}}" tabindex=0 autoplay></video>
    	<canvas id="canvasSource" width="{{width}}" height="{{height}}"></canvas>
    	<canvas id="canvasCutout" width="{{width}}" height="{{height}}"></canvas>
    </template>

    <script>
	    Polymer('hello-world', {
        	audio: false,
        	width: 640,
            height: 480,
            created: function() {
	            if (!window.URL) {
	                window.URL = window.URL || window.webkitURL || window.msURL || window.oURL;
	            }

	            if (!navigator.getUserMedia) {
	                navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
	            }

	            if(!window.requestAnimationFrame) {
	            	window.requestAnimationFrame = window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.oRequestAnimationFrame || window.msRequestAnimationFrame;
	            }
	        },

	        ready: function() {
	            var that = this;

	            that.contextSource = that.$.canvasSource.getContext('2d');
	            that.contextCutout = that.$.canvasCutout.getContext('2d');

	            activateDebugging(that.$.canvasCutout, that.contextSource);

	            function activateDebugging (domForMouseDown, canvasContext) {
		            domForMouseDown.addEventListener('mousedown', function(ev) {
		            	function getColorAtPoint(x, y) {
					        var pixels = canvasContext.getImageData(x, y, 1, 1);
					        var r = pixels.data[0];
					        var g = pixels.data[1];
					        var b = pixels.data[2];

					        return [r,g,b];
					    }

					    console.log(getColorAtPoint(ev.offsetX, ev.offsetY));
		            }, false);
		        }

	            function processFrame() {
		    		that.contextSource.drawImage(that.$.webcam, 0, 0, that.width, that.height);
		    		greenScreen(that.contextSource, that.contextCutout);
		    		window.requestAnimationFrame(processFrame);
		    	}

		    	function getAlpha(color) {
		    		var threshold = 0.1; //min="0" step="0.001" max="0.2"
		    		var replace = [159, 38, 40]; // Some red value

			        var distance = Math.pow(
			            (replace[0] - color[0]) *
			            (replace[0] - color[0]) +
			            (replace[1] - color[1]) *
			            (replace[1] - color[1]) +
			            (replace[2] - color[2]) *
			            (replace[2] - color[2]), 0.5 );

			        return Math.min(1000, Math.exp(distance * threshold));
			    }

		    	function greenScreen(source, target) {
			        var pixels = source.getImageData(0, 0, that.width, that.height);

			        var length = pixels.data.length / 4;

			        for (var i=0; i<length; i++) {
			            var r = pixels.data[i*4 + 0];
			            var g = pixels.data[i*4 + 1];
			            var b = pixels.data[i*4 + 2];

			            pixels.data[i*4 + 3] = getAlpha([r,g,b]);
			        }

			        target.putImageData(pixels, 0, 0);
			    }

	            navigator.getUserMedia({
	                audio: that.audio,
	                video: true
	            },
	            function(stream) {
	                that.$.webcam.src = window.URL.createObjectURL(stream);
	                processFrame();
	            },
	            function(err) {
	                throw Error(err);
	            });
	        }
        });
    </script>
</polymer-element>