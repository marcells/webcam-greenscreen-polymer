<!-- Import Polymer -->
<link rel="import" href="../bower_components/polymer/polymer.html">

<!-- Define your custom element -->
<polymer-element name="hello-world" attributes="width height audio">

    <template>
    	<style>
    		#webcam { display: none;}
    	</style>

    	<video id="webcam" width="{{width}}" height="{{height}}" tabindex=0 autoplay></video>
    	<canvas id="canvasSource" width="{{width}}" height="{{height}}"></canvas>
    </template>

    <script>
	    var requestAnimationFrame = (function() {
	        return  window.requestAnimationFrame       ||
	                window.webkitRequestAnimationFrame ||
	                window.mozRequestAnimationFrame    ||
	                window.oRequestAnimationFrame      ||
	                window.msRequestAnimationFrame     ||
	                function( callback ){
	                    window.setTimeout(callback, 1000 / 40);
	                };
	    })();

        Polymer('hello-world', {
        	audio: false,
        	width: '640',
            height: '480',
            created: function() {
	            if (!window.URL) {
	                window.URL = window.URL || window.webkitURL || window.msURL || window.oURL;
	            }

	            if (!navigator.getUserMedia) {
	                navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
	            }
	        },

	        ready: function() {
	            var that = this;

	            that.contextSource = that.$.canvasSource.getContext('2d');

	            function processFrame() {
		    		that.contextSource.drawImage(that.$.webcam, 0, 0, 640, 480);
		    		requestAnimationFrame(processFrame);
		    	}

	            navigator.getUserMedia({
	                audio: that.audio,
	                video: true
	            },
	            function(stream) {
	                that.$.webcam.src = window.URL.createObjectURL(stream);
	                processFrame();
	            },
	            function(err) {
	                throw Error(err);
	            });
	        }
        });
    </script>
</polymer-element>